definitions:
  base: &base
    max_build_duration: 120
    working_directory: apps/native/app
  default_triggers: &default_triggers
    events:
      - push
    branch_patterns:
      - pattern: "codemagic"
        include: true
        source: true
  scripts:
    - &check_changes
      name: Check changes since last build
      script: |
        set -e

        echo "Considering changes between $CM_PREVIOUS_COMMIT and $CM_COMMIT"
        if git cat-file -e "$CM_PREVIOUS_COMMIT"^{commit} >& /dev/null; then
          notes=$(git log --pretty=format:"%s (%an)" "$CM_PREVIOUS_COMMIT".."$CM_COMMIT" -- codemagic.yaml apps/native/app)
          if [[ $notes == "" ]]; then
            echo "No changes detected in native app. Exiting."
            exit 1
          else
            echo "App changes since last build:"
            echo $notes | tee apps/native/app/release_notes_en-US.txt
          fi
        else
          echo "No previous commit detected. Continuing."
        fi
    - &npm_install
      name: Install npm dependencies
      working_directory: .
      script: |
        corepack enable
        corepack prepare
        yarn install --immutable
    - &codegen
      name: Run codegen
      working_directory: .
      script: |
        yarn codegen
    - &cocoapods
      name: Install CocoaPods dependencies
      script: |
        cd ios && pod install
    - &provisioning_profiles
      name: Set up provisioning profiles settings on Xcode project
      script: xcode-project use-profiles
    - &increment_build_number
      name: Increment build number
      script: |
        cd ios
        LATEST_BUILD_NUMBER=$(app-store-connect get-latest-build-number "$APP_STORE_APPLE_ID")
        agvtool new-version -all $(($LATEST_BUILD_NUMBER + 1))
    - &build_ipa
      name: Build ipa for distribution
      script: |
        xcode-project build-ipa \
          --workspace "ios/$XCODE_WORKSPACE" \
          --scheme "$XCODE_SCHEME"
  ios_publishing: &ios_publishing
    app_store_connect:
      auth: integration
      submit_to_testflight: false
      submit_to_app_store: false

workflows:
  prod-app-ios:
    <<: *base
    name: Island.is Prod App iOS
    instance_type: mac_mini_m1
    triggering: *default_triggers
    integrations:
      app_store_connect: "Island.is API Key"
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: is.island.app
      vars:
        BUNDLE_ID: "is.island.app"
        XCODE_WORKSPACE: "IslandApp.xcworkspace"
        XCODE_SCHEME: "Ísland.is"
        APP_STORE_APPLE_ID: 1569828682
    scripts:
      - *check_changes
      - *npm_install
      - *codegen
      - *cocoapods
      - *provisioning_profiles
      - *increment_build_number
      - *build_ipa
    artifacts: &ios_artifacts
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
    publishing:
      <<: *ios_publishing
      slack:
        channel: '#codemagic-test'
        notify:
          success: false
          failure: true

  dev-app-ios:
    <<: *base
    name: Island.is Dev App iOS
    instance_type: mac_mini_m1
    triggering: *default_triggers
    integrations:
      app_store_connect: "Island.is API Key"
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: is.island.app.dev
      vars:
        BUNDLE_ID: "is.island.app.dev"
        XCODE_WORKSPACE: "IslandApp.xcworkspace"
        XCODE_SCHEME: "Ísland.dev"
        APP_STORE_APPLE_ID: 1570427360
    scripts:
      - *check_changes
      - *npm_install
      - *codegen
      - *cocoapods
      - *provisioning_profiles
      - *increment_build_number
      - *build_ipa
    artifacts: *ios_artifacts
    publishing:
      <<: *ios_publishing
      slack:
        channel: '#codemagic-test'
        notify:
          success: true
          failure: true
