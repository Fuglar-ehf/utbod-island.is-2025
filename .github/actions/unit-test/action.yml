name: 'Unit Test'
description: 'Run unit tests'
inputs:
  node-modules-hash:
    required: true
  generated-files-cache-key:
    required: true
  codecov-token:
    required: true
runs:
  using: "composite"
  steps:
    - name: Cache for NodeJS dependencies - host OS
      uses: actions/cache@v2
      with:
        path: node_modules
        key: ${{ inputs.node-modules-hash }}-yarn

    - name: Cache for generated files
      uses: actions/cache@v2
      with:
        path: generated_files.tar.gz
        key: ${{ inputs.generated-files-cache-key }}

    - name: Untar generated files
      run: tar zxvf generated_files.tar.gz
      shell: bash

    - name: Running tests
      run: ./scripts/ci/run-in-parallel.sh 30_test
      shell: bash

    - name: Install codecov uploader
      run: |
        # Importing pgp keys
        curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import

        curl -O https://uploader.codecov.io/latest/linux/codecov
        curl -O https://uploader.codecov.io/latest/linux/codecov.SHA256SUM
        curl -O https://uploader.codecov.io/latest/linux/codecov.SHA256SUM.sig

        # Integrity check
        gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
        shasum -a 256 -c codecov.SHA256SUM
        rm codecov.SHA256SUM.sig codecov.SHA256SUM
        chmod +x codecov

        # Adding codecov uploader to PATH
        mkdir -p "$HOME/.local/bin"
        mv codecov "$HOME/.local/bin"
        echo "$HOME/.local/bin" >> $GITHUB_PATH
      shell: bash

    - name: Upload coverage reports
      run: ./scripts/ci/run-in-parallel.sh 50_upload-coverage
      shell: bash
      env:
        CODECOV_TOKEN: ${{ inputs.codecov-token }}
