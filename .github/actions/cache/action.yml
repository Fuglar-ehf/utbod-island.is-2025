# You can use this composite action if you want retry functionality with your
# caching action. Because composite actions currently do not have the
# continue-on-error feature we need a second step to check the output of the
# cache action to determine if it ran successfully.
#
# ** Example **
#
# jobs:
#   my-job:
#     steps:
#     - name: Cache node modules
#       id: node-modules
#       continue-on-error: true
#       uses: ./.github/actions/cache
#       with:
#         path: node_modules
#         key: ${{ steps.calculate_node_modules_hash.outputs.node-modules-hash }}-yarn

name: 'Cache'
description: 'Cache with retry'
inputs:
  path:
    description: 'Path(s) to cache'
    required: true
  key:
    description: 'Cache key'
    required: true
  retries:
    description: 'Number of retries'
    required: false
    default: '1'
  retry-interval:
    description: 'Time between retries'
    required: false
    default: '10'
  cache-url:
    description: 'URL to your cache'
    required: false
    default: https://cache.dev01.devland.is/
outputs:
  success:
    description: 'success'
    value: ${{ steps.computed_outputs.outputs.success }}
  cache-hit:
    description: 'cache-hit'
    value: ${{ steps.computed_outputs.outputs.cache-hit }}
runs:
  using: 'composite'
  steps:
    - name: Exit if no retries
      if: inputs.retries <= 0
      shell: bash
      run: exit 1

    - name: Attempting to cache (${{ inputs.retries }} retries left)
      id: cache_attempt
      uses: actions/cache@v3 # Good for local debugging with act ❤️
      # uses: island-is/cache@v0.3
      with:
        path: ${{ inputs.path }}
        key: ${{ inputs.key }}
        cache-url: ${{ inputs.cache-url }}

    - name: Exit successfully if cache is hit
      if: ! cancelled() && steps.cache_attempt.outputs.cache-hit == 'true'
      shell: bash
      run: exit 0

    - name: Sleep for ${{ inputs.retry-interval }} seconds
      if: ! cancelled() && inputs.retries > 0 && steps.cache_attempt.outputs.success != 'true'
      shell: bash
      run: sleep ${{ inputs.retry-interval }}

    - name: Calculate retries left
      shell: bash
      id: retries
      run: echo "retries-left=$(( ${{ inputs.retries }} - 1 ))" >> "$GITHUB_OUTPUT"

    - name: Recursively loop caching
      id: recurse-loop
      if: ! cancelled() && steps.cache_attempt.outputs.success != 'true'
      uses: ./.github/actions/cache
      with:
        path: ${{ inputs.path }}
        key: ${{ inputs.key }}
        retries: ${{ steps.retries.outputs.retries-left }}
        retry-interval: ${{ inputs.retry-interval }}
        cache-url: ${{ inputs.cache-url }}

    - name: Exit if recurse failed
      if: ! cancelled() && steps.recurse-loop.outputs.success != 'true'
      shell: bash
      run: exit 1

    # - name: Cache try number one
    #   id: cache_try_number_one
    #   uses: island-is/cache@v0.3
    #   with:
    #     path: ${{ inputs.path }}
    #     key: ${{ inputs.key }}
    #
    # - name: Give cache server a bit of time to recover
    #   if: ! cancelled() && inputs.retries > 0 && steps.cache_try_number_one.outputs.success != 'true'
    #   shell: bash
    #   run: sleep 10
    #
    # - name: Cache try number two
    #   id: cache_try_number_two
    #   if: ! cancelled() && inputs.retries > 0 && steps.cache_try_number_one.outputs.success != 'true'
    #   uses: island-is/cache@v0.3
    #   with:
    #     path: ${{ inputs.path }}
    #     key: ${{ inputs.key }}
    #
    # - name: Give cache server a bit of time to recover
    #   if: ! cancelled() && inputs.retries > 1 && steps.cache_try_number_one.outputs.success != 'true' && steps.cache_try_number_two.outputs.success != 'true'
    #   shell: bash
    #   run: sleep 10
    #
    # - name: Cache try number three
    #   id: cache_try_number_three
    #   if: ! cancelled() && inputs.retries > 1 && steps.cache_try_number_one.outputs.success != 'true' && steps.cache_try_number_two.outputs.success != 'true'
    #   uses: island-is/cache@v0.3
    #   with:
    #     path: ${{ inputs.path }}
    #     key: ${{ inputs.key }}
    #
    # - name: Gather outputs
    #   id: computed_outputs
    #   if: ! cancelled()
    #   shell: bash
    #   run: |
    #     if [[ "${{ steps.cache_try_number_one.outputs.success }}" == "true" ]] || \
    #        [[ "${{ steps.cache_try_number_two.outputs.success }}" == "true" ]] || \
    #        [[ "${{ steps.cache_try_number_three.outputs.success }}" == "true" ]]
    #     then
    #       echo "success=true" >> $GITHUB_OUTPUT
    #     else
    #       echo "success=false" >> $GITHUB_OUTPUT
    #     fi
    #
    #     if [[ "${{ steps.cache_try_number_one.outputs.cache-hit }}" == "true" ]] || \
    #        [[ "${{ steps.cache_try_number_two.outputs.cache-hit }}" == "true" ]] || \
    #        [[ "${{ steps.cache_try_number_three.outputs.cache-hit }}" == "true" ]]
    #     then
    #       echo "cache-hit=true" >> $GITHUB_OUTPUT
    #     else
    #       echo "cache-hit=false" >> $GITHUB_OUTPUT
    #     fi
