# You can use this composite action if you want retry functionality with your
# caching action. Because composite actions currently do not have the
# continue-on-error feature we need a second step to check the output of the
# cache action to determine if it ran successfully.
#
# ** Example **
#
# jobs:
#   my-job:
#     steps:
#     - name: Cache node modules
#       id: node-modules
#       continue-on-error: true
#       uses: ./.github/actions/cache
#       with:
#         path: node_modules
#         key: ${{ steps.calculate_node_modules_hash.outputs.node-modules-hash }}-yarn

name: 'Cache'
description: 'Cache with retry'
inputs:
  path:
    description: 'Path(s) to cache'
    required: true
  key:
    description: 'Cache key'
    required: true
  retries:
    description: 'Number of retries'
    required: false
    default: '1'
  retry-interval:
    description: 'Time between retries'
    required: false
    default: '10'
  cache-url:
    description: 'URL to your cache'
    required: false
    default: https://cache.dev01.devland.is/
outputs:
  cache-hit:
    description: 'Did the cache key match and restored the cache?'
    value: ${{ steps.computed_outputs.outputs.cache-hit }}
runs:
  using: 'composite'
  steps:
    - name: Exit if no retries
      if: inputs.retries < 0
      shell: bash
      run: exit 1

    - name: Attempting to cache (${{ inputs.retries }} retries left)
      id: cache-attempt
      uses: actions/cache@v3 # Good for local debugging with act ❤️
      # uses: island-is/cache@v0.3
      with:
        path: ${{ inputs.path }}
        key: ${{ inputs.key }}
        cache-url: ${{ inputs.cache-url }}

    - name: Exit successfully if cache is hit
      if: ! cancelled() && steps.cache-attempt.outputs.cache-hit == 'true'
      shell: bash
      run: exit 0

    - name: Sleep for ${{ inputs.retry-interval }} seconds
      if: ! cancelled() && inputs.retries > 0 && steps.cache-attempt.outputs.success != 'true'
      shell: bash
      run: sleep ${{ inputs.retry-interval }}

    - name: Calculate retries left
      shell: bash
      id: calc-retries
      run: echo "retries-left=$(( ${{ inputs.retries }} - 1 ))" >> "$GITHUB_OUTPUT"

    - name: Recursively loop caching
      id: recurse-loop
      if: ! cancelled() && steps.cache-attempt.outputs.success != 'true'
      uses: ./.github/actions/cache
      with:
        path: ${{ inputs.path }}
        key: ${{ inputs.key }}
        retries: ${{ steps.calc-retries.outputs.retries-left }}
        retry-interval: ${{ inputs.retry-interval }}
        cache-url: ${{ inputs.cache-url }}

    - name: Exit if recurse failed
      if: ! cancelled() && steps.recurse-loop.outputs.success != 'true'
      shell: bash
      run: exit 1
