name: ðŸ§ª Kaniko build with dynamic Dockerfile

on:
  pull_request:

concurrency:
  # See https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#example-using-a-fallback-value
  group: kaniko-${{ github.head_ref || github.run_id }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: arc-shared
    container:
      image: gcr.io/kaniko-project/executor:debug
    permissions:
      contents: read
      packages: write

    steps:
      - name: Prepare Dockerfile
        id: prepare-dockerfile
        run: |
          mkdir -p ./images
          cat > ./images/kaniko-build-test.Dockerfile << 'EOF'
          FROM cgr.dev/chainguard/wolfi-base:latest
          RUN apk add --no-cache \
            git \
            jq \
            wget
          CMD ["echo", "hello world"]
          EOF
          echo "Dockerfile created at ./images/kaniko-build-test.Dockerfile"
          cat ./images/kaniko-build-test.Dockerfile
      - name: Build and push container test
        run: |
          # Write config file, change to your destination registry
          AUTH=$(echo -n ${{ github.actor }}:${{ secrets.GITHUB_TOKEN }} | base64)
          echo "{\"auths\": {\"ghcr.io\": {\"auth\": \"${AUTH}\"}}}" > /kaniko/.docker/config.json

          export GIT_USERNAME="kaniko-bot"
          export GIT_PASSWORD="${{ secrets.GITHUB_TOKEN }}" # works for GHEC or GHES container registry

          /kaniko/executor --dockerfile="./images/kaniko-build-test.Dockerfile" \
            --context="${{ github.repositoryUrl }}#${{ github.ref }}#${{ github.sha }}" \
            --destination="ghcr.io/island-is/island.is/kaniko-build:test" \
            --push-retry 5 \
            --image-name-with-digest-file /workspace/image-digest.txt
