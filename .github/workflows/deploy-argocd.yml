name: Upload manifest to argocd repo

on:
  push:
    branches:
      - mq-docker-test-token

jobs:
  upload:
    runs-on: arc-runners
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: Setup yarn
        uses: ./.github/actions/setup-yarn
      - name: Get manifest data
        id: manifest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/ci/docker/get-data.mjs
      - name: Update helm-values repository
        uses: ./.github/actions/update-helm-values
        if: ${{ steps.manifest.outputs.MQ_HAS_OUTPUT == 'true' }}
        with:
          files: ${{ steps.manifest.outputs.MQ_CHANGED_FILES }}
          ssh-key: ${{ secrets.HELM_VALUES_SSH_KEY }}

  test:
    runs-on: arc-runners
    steps:
    - name: Checkout helm-values repository
      uses: actions/checkout@v4
      with:
        repository: island-is/helm-values
        ref: main
        ssh-key: ${{ secrets.HELM_VALUES_SSH_KEY }}
        path: helm-values
    - name: Commit and push changes to helm-values repository
      shell: bash
      run: |
        cd helm-values
        git config --global user.email "ci@island.is"
        git config --global user.name "CI Bot"

        echo "hallo" > test.txt
        git add .
        git commit -m "Updated helm charts"
        echo "Showing changeset\n $(git show)"
        git push
