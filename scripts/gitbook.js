const fs = require('fs')
const path = require('path')

/**
 * Represents the number of common folder/file to go through before finding a `README.md`.
 * - apps/something/README.md -> 3
 *
 * If more than this, we use the difference to build the sub-README.md hierarchy.
 */
const ROOT_LEVEL = 3

const printContent = (apps, libs, overview, repo, misc) => {
  const formatDeep = (arr) =>
    arr
      .map(({ name, path, fromRoot }, index) => {
        const deep = fromRoot ? Array(fromRoot).fill(`  `).join('') : ``

        return `${deep}- [${name}](${path})${
          index === arr.length - 1 ? '' : '\n'
        }`
      })
      .join('')

  const formatRepository = repo
    .map(
      ({ name, path }, index) =>
        `- [${name}](${path})${index === repo.length - 1 ? '' : '\n'}`,
    )
    .join('')

  const formatMisc = misc
    .map(({ name, path }) => `- [${name}](${path})\n`)
    .join('')

  return `<!-- This file is automatically generated with \`yarn gitbook\` (scripts/gitbook.js), please do not modify this file directly -->

# Table of contents

- [Getting started](README.md)

## Technical overview

${formatDeep(overview)}

## Repository

${formatRepository}

## Apps

${formatDeep(apps)}

## Libs

${formatDeep(libs)}

## Misc

${formatMisc}`
}

const fromDir = async (startPath, res = [], readmeAsRoot = false) => {
  if (!fs.existsSync(startPath)) {
    return
  }

  const files = fs.readdirSync(startPath)

  // We move readme as first file of the array if it exists.
  const orderedFiles = [
    ...files.filter((name) => name.includes('README.md')),
    ...files.filter((name) => !name.includes('README.md')),
  ]

  for (const file in orderedFiles) {
    const filename = path.join(startPath, orderedFiles[file])
    const stat = fs.lstatSync(filename)

    if (stat.isDirectory()) {
      fromDir(filename, res, readmeAsRoot)
    } else if (/\.md$/.test(filename)) {
      const file = fs.readFileSync(filename, 'utf-8')
      const lines = file.split('\n')
      const firstLine = lines[0] && lines[0]

      if (firstLine === '<!-- gitbook-ignore -->') {
        return
      }

      const deep = filename.split('/')
      const { length } = deep
      const level = length - ROOT_LEVEL

      const fromRoot =
        level > 0
          ? readmeAsRoot
            ? filename.includes('README.md')
              ? level - 1
              : level
            : level
          : undefined

      res.push({
        name: firstLine.replace('# ', ''),
        path: filename,
        fromRoot,
      })
    }
  }

  return res
}

/**
 * This script creates a SUMMARY.md file used by GitBook to create its table of contents.
 *
 * We automatically get all *.md files in the different directories listed below.
 * We use the first line of the readme to define the name of the GitBook page.
 *
 * If a README.md is not worth being listed in GitBook, use `<!-- gitbook-ignore -->` on
 * the first line of the file.
 *
 * To run this script, do `yarn gitbook`
 */
const generateSummary = async () => {
  const [apps, libs, overview, repo, misc] = await Promise.all([
    await fromDir('./apps'),
    await fromDir('./libs'),
    await fromDir('./handbook/technical-overview', [], true),
    await fromDir('./handbook/repository'),
    await fromDir('./handbook/misc'),
  ])

  fs.writeFileSync('SUMMARY.md', printContent(apps, libs, overview, repo, misc))
}

const run = async () => {
  await generateSummary()
}

run()
